events {
    worker_connections          1024;
}

# 由于 hedgedoc 在指定了 CMD_DOMAIN=localhost 后, 会导致页面中的资源请求失败, 因此需要通过 nginx 进行反向代理, 并替换 localhost 为实际访问的 host;
# 另外, sub_filter 只能替换未压缩的 html 内容, 因此需要禁用 gzip 压缩

http {
    server {
        listen                  ${NGINX_LISTEN_PORT};
        server_name             _;

        client_max_body_size    100M;

        add_header              Access-Control-Allow-Origin * always;
        add_header              Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header              Access-Control-Allow-Headers "Authorization, Content-Type" always;

        location / {
            proxy_pass          http://hedgedoc:${HEDGEDOC_PORT};
            proxy_set_header    Host $host;
            proxy_set_header    X-Real-IP $remote_addr;
            proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header    X-Forwarded-Proto $scheme;
            proxy_set_header    Accept-Encoding "";

            proxy_redirect      http://localhost:${HEDGEDOC_PORT}/ http://$http_host/;
            proxy_redirect      ~^http://localhost:${HEDGEDOC_PORT}/(.*)$ http://$http_host/$1;

            sub_filter          'http://localhost:' 'http://$host:';
            sub_filter          '//localhost:' '//$host:';
            sub_filter_once     off;
            sub_filter_types    text/html text/css text/javascript application/javascript application/json;
        }

        location /socket.io/ {
            proxy_pass          http://hedgedoc:${HEDGEDOC_PORT};
            proxy_set_header    Host $http_host;
            proxy_set_header    X-Real-IP $remote_addr;
            proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header    X-Forwarded-Proto $scheme;
            proxy_set_header    Upgrade $http_upgrade;
            proxy_set_header    Connection "upgrade";
        }
    }
}
